>Metrics - variable to monitor CPU, RAM etc. Has timestamps.\
Insight - wgląd, rozeznanie

# CloudWatch

Provides metrics for every service in AWS.

## CloudWatch METRICS

Metrics belongs to namespaces (groups).\
Dimension is an attribute of a metric (instance id, environment, etc...).\
Column name in AWS Console. Up to 10 dimensions per metric.

EC2 Default - metrics every 5mins, Detailed - every 1 min (paid extra)
Billing - Total Estimated Charge is available only in us-east-1 (for whole account)

### Custom Metrics

For custom metrics is used API call: PutMetricData. It can be send with with dimensions (attributes) to segment metrics: Instance.Id, Environment.name.

Examples:
* memory usage (RAM)
* disk space
* number of logged users

Resolution:
* standard - 1min
* high resolution: 1, 5, 10, 30 seconds (higher cost)

Metrics are accepted with timestamp for 2 weeks in the past and 2 hours in the future. You must be sure about time settings in your server.

Push metric data:
```
aws cloudwatch put-metric-data --namespace "Usage Metrics" --metric-data file://metric.json

[
  {
    "MetricName": "New Posts",
    "Timestamp": "Wednesday, June 12, 2013 8:28:20 PM",
    "Value": 0.50,
    "Unit": "Count"
  }
]
```
```
aws cloudwatch put-metric-data --metric-name Buffers --namespace MyNameSpace --unit Bytes --value 231434333 --dimensions InstanceID=1-23456789,InstanceType=m1.small
```

## CloudWatch LOGS

Sources:
* SDK
* CloudWatch log agent (unified)
* ElasticBeanstalk application
* ECS - logs from containers
* Lambda - logs from function
* VPC Flow Logs
* CloudTrail based on filter
* Route53 DNS queries
* API gateway

Destinations:
* S3 (exports)
* Kinesis Data SStream
* Kinesis Data Firehouse
* AWS Lambda
* Elasticsearch

>Log groups - name that is representing application (can be any name).

>Log stream - instances within application, log files, containers

CloudWatch log agent -can be installed on EC2 machines or on-premise servers for collecting logs by CloudWatch.

Filter expressions - can be used to ex: find specific IP within a log or count "ERROR" occurrences (create metric) and trigger CloudWatch Alarm.

Log expiration policies - can be set to amount of time (max 10 years) or disable retention.

Log Insights - can be used to query logs and add queries to CloudWatch Dashboards.

Subscription Filter - can be used to send logs into other services (Lambda, ES, Kinesis) in near real-time.

## CloudWatch ALARMS

Trigger notifications for any metric.

Alarm states:
>OK                 - all is alright\
>INSUFFICIENT_DATA  - not enough data points to decide\
>ALARM              - when state is wrong

Targets:
* EC2 - stop, Terminate, Recover instance
* ASG - trigger Auto-scaling action
* SNS - send notification into an SNS topic (later to Lambda)

Status check:
* Instance status - check the VM
* System status - check the underlying hardware

StatusCheckFailed_System - can be used to recover the EC2 (same subnet, Elastic IP, metadata, placement group).

To set the alarming state (testing) use CLI:\
`aws cloudwatch set-alarm-state --alarm-name "my-alarm" --state-value ALARM --state-reason "testing purposes`

## CloudWatch EVENTS

Make an action on target when event occur on source by creating Event rule.

* Event pattern - get events from AWS services (sources) to make reaction (SNS topic when IAM root user logged in). Can get any API call using CloudTrail integration.
* Schedule cron jobs

JSON payload is created from the event and passed to a target:
* compute - Lambda, Batch ECS task
* integration - SQS, SNS, Kinesis
* orchestration - Step functions, CodePipeline, CodeBuild
* maintenance - SSM, EC2 Action

### Amazon EventBridge
Evolution of CloudWatch events. It uses teh same service API and endpoint.

* Default Event BUS - generated by AWS services (CloudWatch Events)
* Partner Event Bus - receive event from SaaS service or applications (DataDog, Auth0)
* Custom Event Buses - for your own applications

Events can be archived after sent to Event Bus, and replayed from archive.

Rules - defines how to process the events.

Schema Registry:\
Event Bridge can analyze the events in bus and gather the schema.
Schema (JSON) registry allows you to generate the code from your application, that will know in advance how data is structured in the event bus. Schema can be versioned.

Resource-based Policy:\
Event Buses can be accessed from other AWS accounts. Policy manage permissions for a specific Event Bus, ex: allow/ deny events from another AWS account. Use-case: to aggregate all events from AWS Organization in a single AWS account.

Sandbox:\
Test rules and patterns without creating the rule.

## CloudWatch DASHBOARDS
* dashboards are global
* can include graphs from different AWS accounts and regions
* timezone and time range can be changed
* automatic refresh (10s-15m)
* can be shared with people without AWS account (public, email address, 3rd party SSO through Amazon Cognito)
* 3 dashboards (up to 50 metrics) for free, $3 per dsb per month

# CloudTrail (ślad)
Governance, compliance and audit for AWS account.
Enabled by default, diagnose who did what.
History of events/API calls within account (console, CLI, SDK connections), can put logs to CloudWatch or S3.

Events types:
* Management Events (logged by default) - operations performed on resources: create resource, attach policy. Read and Write events (modifications). No charges, KMS events can be excluded (amount).

* Data Events (not logged by default) - operations on S3 object level: Get, Put, Delete Object, Lambda executions. Read and Write events.

* Insight Events (additional payment) - detect unusual activities (service limits, provisioning problems, gaps in maintenance). Create baseline of normal activity and continuously analyze write events.

Retention:\
Events are stored by 90 days. Can be stored in S3 to use in Athena (SQL analysis).

Log File Integrity Validation
Digest Files - reference of log files from last hour - contains hash of each log file. Is stored in the same bucket as logs, but in different directory (index).
Determine if log file was modified after deliver by CloudTrail. Bucket should be protected by: policy, versioning, MFA Delete Protection, encryption, object lock.

Integration with EventBridge
Every API call can be sent to Event Bridge. Cloudtrail is not real-time, 15 min for event delivery, 5 mins to store log file in S3 bucket.

Organization Trails
CloudTrail can be set on Organization level - events from all accounts in Organization. Member accounts have read-only access to it't trails.

# Service Quotas

How near you are from reaching service limits. CloudWatch Alarm can be set when you're close to threshold. You can check any type of actions and request for higher quota value.

# AWS Config

Record configurations of services and it's changes over time for audits and compliance needs. Use rules to check f current config is compliant or not. Rules don't prevent actions from happening - it's only view of changes. Configuration data can be stored in S3 to analyze in Athena. Alerts using SNS notifications when configuration changes (resource is non-compliant). Per region service, data can be aggregated form many regions. Paid service.

Problems:
* Is any unrestricted SSH access in my security groups?
* Do any of my buckets have public access?
* Has my ELB configuration changed over time?

Config Rules:
* AWS managed config rules (over 75)
* custom rules (must be defined in AWS Lambda)

Rules can be evaluated/triggered:
* for each config change
* scheduled

>Pricing - $0.003 per configuration item recorded, $0.001 per config rule evaluation.

### Remediation (korekta)
Non-compliant resources can be remediated using SSM Automation Documents (can be custom). Max 5 Remediation Retries. Ex: deactivate ssk keys older than 90 days.

### Aggregators
One AWS Account that has enabled aggregator - centralized view of config from all source accounts. It's aggregates rules, resources, etc across multiple account and regions. Without Organizations on all account must be created authorizations.
Rules are created in each account separately, to deploy rules to multiple target account CloudFormation StackSets must be used.


